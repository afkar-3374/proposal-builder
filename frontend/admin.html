<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Proposal Builder</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* =================== Login Overlay =================== */
    #loginOverlay { position: fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; }
    #loginBox { background:#fff; padding:40px; border-radius:12px; width:320px; text-align:center; box-shadow:0 8px 16px rgba(0,0,0,0.2); }
    #loginBox h2 { color:#2196F3; margin-bottom:20px; }
    #loginBox input { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ccc; }
    #loginBox button { width:100%; padding:10px; border:none; border-radius:8px; background:#2196F3; color:#fff; font-size:16px; cursor:pointer; transition:0.3s; }
    #loginBox button:hover { background:#1976d2; }
    #loginMsg { color:red; font-weight:bold; margin-top:10px; }

    /* Modal Card Styles */
    .modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background: rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:8% auto; padding:25px; border-radius:12px; max-width:500px; box-shadow:0 12px 24px rgba(0,0,0,0.3); animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { transform: translateY(-50px); opacity:0; } to { transform: translateY(0); opacity:1; } }
    .close-btn { float:right; font-size:24px; font-weight:bold; cursor:pointer; }
    .modal h3 { margin-top:0; color:#2196F3; }
    .modal p { margin:6px 0; line-height:1.5; }
    .modal ul { padding-left:20px; }
    .modal ul li { margin-bottom:5px; }

    /* Table & Buttons */
    .action-btn { padding:5px 10px; border:none; border-radius:6px; cursor:pointer; font-size:14px; margin:2px; transition:0.3s; }
    .view-btn { background:#2196F3; color:#fff; } .view-btn:hover { background:#1976d2; }
    .approve-btn { background:#4CAF50; color:#fff; } .approve-btn:hover { background:#388e3c; }
    .delete-btn { background:#f44336; color:#fff; } .delete-btn:hover { background:#d32f2f; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="loginOverlay">
    <div id="loginBox">
      <h2>Admin Login</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <div id="loginMsg"></div>
    </div>
  </div>

  <div class="container" id="adminPanel" style="display:none;">
    <h1>üìë Admin - Submitted Proposals</h1>
    <button onclick="logout()" style="float:right;margin-bottom:10px;background:#f44336;">Logout</button>
    <table id="proposalTable">
      <thead>
        <tr>
          <th>Project Name</th>
          <th>Submitted By</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="message"></p>
  </div>

  <!-- Modal -->
  <div id="viewModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const BASE_URL = "https://proposal-builder-sndn.onrender.com/api/proposals";

    const ADMIN_USER = "CW";
    const ADMIN_PASS = "0816";

    function login() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      const msg = document.getElementById("loginMsg");

      if(user === ADMIN_USER && pass === ADMIN_PASS) {
        localStorage.setItem("adminLoggedIn", "true");
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadProposals();
      } else {
        msg.textContent = "‚ùå Invalid credentials";
      }
    }

    function logout() {
      localStorage.removeItem("adminLoggedIn");
      location.reload();
    }

    if(localStorage.getItem("adminLoggedIn") === "true") {
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";
      loadProposals();
    }

    const tableBody = document.querySelector("#proposalTable tbody");
    const modal = document.getElementById("viewModal");
    const modalBody = document.getElementById("modalBody");

    async function loadProposals() {
      try {
        const res = await fetch(BASE_URL);
        const proposals = await res.json();

        tableBody.innerHTML = "";
        proposals.forEach(p => {
          const row = document.createElement("tr");
          const status = p.approved ? "‚úÖ Approved" : "‚åõ Pending";

          row.innerHTML = `
            <td>${p.title}</td>
            <td>${p.submittedBy || "N/A"}</td>
            <td>${status}</td>
            <td>
              <button class="view-btn action-btn" onclick="viewProposal('${p._id}')">View</button>
              <button class="approve-btn action-btn" onclick="approveProposal('${p._id}')">Approve</button>
              <button class="delete-btn action-btn" onclick="deleteProposal('${p._id}')">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (err) { console.error(err); }
    }

    async function viewProposal(id) {
      try {
        const res = await fetch(BASE_URL);
        const proposals = await res.json();
        const p = proposals.find(p => p._id === id);
        if(!p) return alert("Proposal not found.");

        modalBody.innerHTML = `
          <h3>${p.title}</h3>
          <p><b>Description:</b> ${p.description}</p>
          <p><b>Submitted By:</b> ${p.submittedBy} | <b>Phone:</b> ${p.phone}</p>
          <p><b>Total Amount:</b> ‚Çπ${p.total}</p>
          <p><b>Status:</b> ${p.approved ? "‚úÖ Approved" : "‚åõ Pending"}</p>
          <p><b>Items:</b></p>
          <ul>
            ${p.items.map(it => `<li>${it.name}: ‚Çπ${it.cost}</li>`).join("")}
          </ul>
        `;
        modal.style.display = "block";
      } catch (err) { console.error(err); }
    }

    function closeModal() { modal.style.display = "none"; }
    window.onclick = function(event) { if(event.target == modal) closeModal(); }

    async function deleteProposal(id) {
      if(!confirm("Are you sure to delete this proposal?")) return;
      try {
        const res = await fetch(`${BASE_URL}/${id}`, { method: "DELETE" });
        if(res.ok) {
          alert("‚úÖ Deleted successfully");
          loadProposals();
        } else {
          const data = await res.json();
          alert("‚ùå Delete failed: " + (data.error || res.status));
        }
      } catch(err) { console.error(err); }
    }

    async function approveProposal(id) {
      try {
        const res = await fetch(`${BASE_URL}/${id}/approve`, { method: "PUT" });
        if(res.ok) {
          alert("‚úÖ Approved");
          loadProposals();
        } else { alert("‚ùå Approval failed"); }
      } catch(err) { console.error(err); }
    }
  </script>
</body>
</html>
